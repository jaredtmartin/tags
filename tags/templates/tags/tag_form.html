{% extends "design/base.html" %}
{% block content %}
  <div class="row" id="name-section">
    <div class="col-md-6 col-md-offset-3 page-header">
      <h1 id="tag_name">{{object.name}}</h1>
      <div class="col-md-2 col-md-offset-8">
        <a id="renameTagModal" href="#">Rename</a>
      </div>
    </div>
  </div>
  <div class="row" id="image-section">
    <div class="col-md-4 col-md-offset-4">
      <img id="tag-image" src="{{object.image.url_300x250}}">
    </div>
    <div class="col-md-3 col-md-offset-6">
      <a href="#" onclick="$('#image_browser').trigger('click');">Change Photo</a>
    </div>
    <div class="hiddenfile">
      <form id="image-form" action="{% url "change_image" object.pk %}" method="post">
        {% csrf_token %}
        <input name="image" type="file" id="image_browser"/>
      </form>
    </div>
  </div>
  <div id="ajax-data" style="display: none;"></div>
{% endblock content %}
{% block js %}
  <script src="{{STATIC_URL}}js/bootbox.min.js"></script>
  <script src="{{STATIC_URL}}js/jquery.form.js"></script>
  <script type="text/javascript">
    function saveDataInCache(data){
      $('#ajax-data').replaceWith('<div id="ajax-data" style="display: none;"></div>'); // Clear temp data cache
      return $('#ajax-data').append(data); // Add new data to cache
    }
    function updateMessages(data){
      $('.message:visible').remove();
      $('.message', d).appendTo($('#messages'));
    }
    function updateTagName(data, result){
      d=saveDataInCache(data);
      updateMessages(d);
      $('#tag_name').html($('#id_name',d).val());
    }
    function updateTagImage(data, result){
      d=saveDataInCache(data);
      updateMessages(d);
      $("#tag-image").attr("src",$('#image-src-data',d).html());
    }
    $(document).on("change", "#image_browser", function(e) {
      $('#image-form').submit(); 
    });
    $(document).on("click", "#renameTagModal", function(e) {
      bootbox.prompt({
        title: "Choose a name for this tag.",
        value: $('#tag_name').html(),
        callback: function(result) {
          if (result != null) {
            url='{% url "change_name" tag.pk %}';
            data={name: result, csrfmiddlewaretoken:$("input[name='csrfmiddlewaretoken']").val()};
            $.ajax({
              url: url,
              type:'POST',
              data:data,
              success: updateTagName,
            });
          }
        }
      });
    });
    $(document).ready(function() { 
      $('#image-form').ajaxForm(updateTagImage); 
    });
  </script>
{% endblock js %}
